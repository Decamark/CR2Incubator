# CR2Incubator

![sample](/jpg/2019_09_20/20190920_061747.jpg)

撮影日時付きで CR2 から JPEG を抽出する。

## Background
以前から連写した CR2 画像の整理を煩わしく思っていました。記録用であれば CR2 → JPEG の変換を行い、撮影日時などでまとめることができれば十分です。
しかしながら、Python の外部パッケージ (Pillow/rawkit/Piexif) には以下の問題点がありました:

* 変換が遅い
* CR2 のメタデータをうまく読み取ってくれない

画像のフォーマットにも興味があったので、調査を行い、以下の処理を行うスクリプトを Python で実装しました:

* CR2 から撮影日時を抽出
* CR2 から向きを抽出
* CR2 から非可逆圧縮の JPEG を抽出
* 撮影日時と向きを埋め込んだ Exif を JPEG に追加

以下、詳細な説明:

## CR2
CR2 とは Canon Raw v2 フォーマットのことで、実質的に JPEG のコンテナです。内部には以下の JPEG 画像が含まれます:

* IFD#0: 原寸大画像 (圧縮あり)
* IFD#1: サムネイル画像 (圧縮あり)
* IFD#2: サムネイル画像 (圧縮なし)
* IFD#3: Loseless JPEG

このうち、生のデータを持っているのは Loseless JPEG (可逆圧縮の JPEG) ですが、ファイルサイズが大きく大量の写真を保存するには向いていないので、原寸大画像の保存を推奨します。

CR2 はメタデータの記述に、JPEG の Exif と同じ TIFF フォーマットを用いています。このデータは Image File Directory (IFD) という箇所に格納されています。CR2 の詳しいフォーマットは[参考](#参考)文献を参照してください。

以下、sample.CR2 を例に、今回の抽出に関係する箇所を表にまとめておきます。

| Offset (hex) | Binary (hex) | Desc |
| ------------ | ------------ | ---- |
| 0   | `49 49`       | バイトオーダー |
| 2   | `2a 00`       | TIFF マジックワード |
| 4   | `10 00 00 00` | IFD#0 へのオフセット |
| 8   | `43 52`       | CR2 マジックワード |
| a   | `02`          | CR2 メジャーバージョン |
| b   | `00`          | CR2 マイナーバージョン |
| c   | `e2 af 00 00` | IFD#3 へのオフセット |
| 10  | `12 00`       | IFD#0 中のエントリ数 |
| 12  | `00 01 03 00 01 00 00 00 70 17 00 00` | 最初のエントリ |
| ... | ... | ... |
| 5a  | `11 01 04 00 01 00 00 00 44 16 01 00` | StripOffset (0x00011644) |
| 66  | `12 01 03 00 01 00 00 00 01 00 00 00` | Orientation (upper left) |
| 72  | `17 01 04 00 01 00 00 00 9c 4c 3d 00` | StripByteCounts (0x003d4c9c) |
| ... | ... | ... |
| d2  | `69 87 04 00 01 00 00 00 be 01 00 00` | ExifOffset (0x000001be) |
| ... | ... | ... |
| 1be | `26 00`       | SubIFD 中のエントリ数 |
| ... | ... | ... |
| 214 | `03 90 02 00 14 00 00 00 9c 03 00 00` | DateTimeOriginal (0x0000039c) |
| ... | ... | ... |
| 39c | `32 30 31 39 3a 30 39 3a 32 30 20 30 36 3a 31 37 3a 34 37 00` | 2019:09:20 06:17:47\x00 |

今回の現像では IFD#0 にある圧縮された原寸大画像を抽出するので、IFD#0 中の StripOffset と StripByteCounts を使います。`0x5a` のエントリ中に存在するオフセットへ飛ぶと JPEG のマーカー`0xffd8` が見えるはずです (オフセットはバイトオーダーからの距離です)。

`0x66` のエントリは画像の向きを保存しています。

また、撮影日時は `0x39c` に存在し、最後がヌル文字になっています。

これで画像と向き、撮影日時の抽出が終わったので、次は撮影日時の埋め込みに移ります。

## JPEG
JPEG は**マーカー**という、`0xff??` の値を持つタグを使って情報を区切ります。`0xffd8` で始まり、`0xffd9` で終了します。Exif は APP1 マーカー (`0xffe1`) を用いてデータを表現するため、抽出した JPEG の先頭にこのマーカーを追加することで、撮影日時情報を追加します。

詳しいフォーマットは[参考](#参考)文献を参照していただくとして、以下は CR2 から抽出した JPEG に対して追加するマーカーを説明したものです。

| Offset (hex) | Binary (hex) | Desc |
| ------------ | ------------ | ---- |
| 0       | `ff e1`       | APP1 マーカー |
| 2       | `00 50`       | マーカーのサイズ |
| 4       | `45 78 69 66 00 00` | Exif のヘッダ |
| a  (0)  | `49 49`       | バイトオーダー |
| c  (2)  | `2a 00`       | TIFF マジックワード |
| e  (4)  | `08 00 00 00` | IFD#0 へのオフセット |
| 12 (8)  | `02 00`       | IFD#0 中のエントリ数 |
| 14 (a)  | `12 01 03 00 01 00 00 00 01 00 00 00` | Orientation (upper left) |
| 20 (16) | `69 87 04 00 01 00 00 00 26 00 00 00` | ExifOffset (0x00000026) |
| 2c (22) | `00 00 00 00` | Next IFD offset |
| 30 (26) | `01 00`       | SubIFD 中のエントリ数 |
| 32 (28) | `03 90 02 00 14 00 00 00 34 00 00 00` | DateTimeOriginal (0x0000034) |
| 3e (34) | `32 30 31 39 3a 30 39 3a 32 30 20 30 36 3a 31 37 3a 34 37 00` | 2019:09:20 06:17:47\x00 |

`0x2` のマーカーのサイズには、マーカー自身の大きさ (2B) は含まれません。また、サイズはビッグエンディアンで保存します。

TIFF の部分は CR2 とあまり変わりませんが、オフセットがバイトオーダーからの距離であることに注意してください。

## 参考
* [Understanding What is stored in a Canon RAW .CR2 file, How and Why](http://lclevy.free.fr/cr2/)
* [CANON RAW V2 FORMAT](https://github.com/lclevy/libcraw2/blob/master/docs/cr2_poster.pdf)
* [Description of Exif file format](https://www.media.mit.edu/pia/Research/deepview/exif.html)
